image: node:18

definitions:
  caches:
    npm: ~/.npm

pipelines:
  branches:
    main:
      - step:
          name: Build (subfolder)
          caches:
            - npm
          script:
            - cd morrisons_store_finder
            # install deps without optional native modules that may require kernel access
            - npm install --silent --no-audit --no-optional
            # avoid CRA treating warnings as errors in CI
            - CI=false npm run build
          artifacts:
            - morrisons_store_finder/build/**
      - step:
          name: Deploy to Vercel
          deployment: production
          script:
            - cd morrisons_store_finder
            # use npx to run vercel CLI without global install
            - npx --yes vercel --version
            # deploy to Vercel; requires VERCEL_TOKEN (set in repo variables)
            - npx --yes vercel --token $VERCEL_TOKEN --prod --confirm
          
  custom:
    deploy-vercel:
      - step:
          name: Deploy (manual) to Vercel
          image: node:18
          caches:
            - npm
          script:
            - cd morrisons_store_finder
            - npm install --silent --no-audit --no-optional
            - CI=false npm run build
            - npx --yes vercel --version
            - npx --yes vercel --token $VERCEL_TOKEN --prod --confirm